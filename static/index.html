<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Panel</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <header style="position: relative;">
            <h1>üé¨ IPTV Panel</h1>
            <p>Kelola Playlist & Stream Relay IPTV Anda</p>
            <div style="position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px;">
                <span id="adminUsername" style="color: #666;"></span>
                <button onclick="showChangePasswordModal()" class="btn" style="padding: 8px 16px; background: #2196F3;">üîë Ganti Password</button>
                <button onclick="logout()" class="btn" style="padding: 8px 16px;">üö™ Logout</button>
            </div>
        </header>
        
        <!-- Stats Dashboard -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="totalPlaylists">0</h3>
                <p>Total Playlists</p>
            </div>
            <div class="stat-card">
                <h3 id="totalChannels">0</h3>
                <p>Total Channels</p>
            </div>
            <div class="stat-card">
                <h3 id="activeChannels">0</h3>
                <p>Active Channels</p>
            </div>
            <div class="stat-card">
                <h3 id="totalRelays">0</h3>
                <p>Total Relays</p>
            </div>
        </div>

        <!-- Bandwidth Monitor -->
        <div id="bandwidthMonitor" style="padding: 20px; background: #f8f9fa;">
            <h3 style="margin-bottom: 15px;">üìä Bandwidth Monitor</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div class="stat-card">
                    <h3 id="downloadMbps" style="font-size: 1.8em;">0.00</h3>
                    <p>‚¨áÔ∏è Download (Mbps)</p>
                </div>
                <div class="stat-card">
                    <h3 id="uploadMbps" style="font-size: 1.8em;">0.00</h3>
                    <p>‚¨ÜÔ∏è Upload (Mbps)</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDownloadMB" style="font-size: 1.8em;">0.00</h3>
                    <p>üì• Total Download (MB)</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalUploadMB" style="font-size: 1.8em;">0.00</h3>
                    <p>üì§ Total Upload (MB)</p>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('playlists', event)">Playlists</button>
            <button class="tab" onclick="switchTab('channels', event)">Channels</button>
            <button class="tab" onclick="switchTab('relays', event)">Relays</button>
            <button class="tab" onclick="switchTab('users', event)">Users</button>
            <button class="tab" onclick="switchTab('generate-playlist', event)">Generate Playlist</button>
            <button class="tab" onclick="switchTab('import', event)">Import M3U</button>
        </div>

        <!-- Playlists Tab -->
        <div id="playlists" class="tab-content active">
            <h2>Daftar Playlists</h2>
            <div id="playlistsList"></div>
        </div>

        <!-- Channels Tab -->
        <div id="channels" class="tab-content">
            <h2>Daftar Channels</h2>
            <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: stretch;">
                <div class="search-box" style="flex: 1;">
                    <input type="text" id="channelSearch" placeholder="üîç Cari channel..." oninput="debounceSearch()">
                </div>
                <select id="categoryFilter" onchange="filterByCategory()" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; cursor: pointer;">
                    <option value="">üìÇ Semua Kategori</option>
                </select>
                <button class="btn btn-danger btn-sm" onclick="deleteCategoryBatch()" id="deleteCategoryBtn" disabled style="white-space: nowrap; min-width: 120px;">
                    üóëÔ∏è Hapus
                </button>
            </div>
            <div id="channelsList"></div>
        </div>

        <!-- Relays Tab -->
        <div id="relays" class="tab-content">
            <h2>Daftar Relays</h2>
            <button class="btn btn-primary" onclick="showCreateRelay()">‚ûï Buat Relay Baru</button>
            
            <div id="createRelayForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>Buat Relay Baru</h3>
                <div class="form-group">
                    <label>Output Path</label>
                    <input type="text" id="relayPath" placeholder="contoh: stream1">
                </div>
                <div class="form-group">
                    <label>Source URLs (satu per baris)</label>
                    <textarea id="relayUrls" rows="5" placeholder="http://source1.com/stream&#10;http://source2.com/stream"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createRelay()">Buat Relay</button>
                <button class="btn" onclick="hideCreateRelay()">Batal</button>
            </div>
            
            <div id="relaysList"></div>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <h2>User Management</h2>
            <button class="btn btn-primary" onclick="showCreateUser()">‚ûï Tambah User</button>
            
            <div id="createUserForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>Buat User Baru</h3>
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="newUsername" placeholder="Masukkan username">
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="newPassword" placeholder="Masukkan password">
                </div>
                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="newFullName" placeholder="Nama lengkap user">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="newEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Max Koneksi</label>
                    <input type="number" id="newMaxConnections" value="1" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Durasi (Hari)</label>
                    <input type="number" id="newDurationDays" placeholder="Jumlah hari aktif (kosongkan untuk unlimited)">
                </div>
                <div class="form-group">
                    <label>Catatan</label>
                    <textarea id="newNotes" placeholder="Catatan tambahan..." rows="3"></textarea>
                </div>
                <button class="btn btn-primary" onclick="createUser()">Buat User</button>
                <button class="btn" onclick="hideCreateUser()">Batal</button>
            </div>
            
            <div id="usersList"></div>
        </div>

        <!-- Generate Playlist Tab -->
        <div id="generate-playlist" class="tab-content">
            <h2>Generate Playlist untuk User</h2>
            
            <div style="max-width: 800px;">
                <div class="form-group">
                    <label>Pilih User</label>
                    <select id="playlistUser" onchange="loadUserInfo()">
                        <option value="">-- Pilih User --</option>
                    </select>
                </div>
                
                <div id="userInfoBox" style="display: none; padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">üìã Info User</h4>
                    <div id="userInfoContent"></div>
                </div>
                
                <div class="form-group">
                    <label>Nama Playlist</label>
                    <input type="text" id="playlistFileName" placeholder="playlist-username">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>üîç Cari Channel</label>
                        <input type="text" id="playlistChannelSearch" placeholder="Ketik untuk mencari..." oninput="filterPlaylistChannels()">
                    </div>
                    
                    <div class="form-group">
                        <label>üìÇ Filter Kategori</label>
                        <select id="playlistCategoryFilter" onchange="filterPlaylistChannels()">
                            <option value="">Semua Kategori</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="selectAllVisible()">‚úÖ Pilih Semua yang Tampil</button>
                    <button class="btn" onclick="deselectAllVisible()">‚ùå Hapus Semua Pilihan</button>
                    <button class="btn btn-primary" onclick="selectByCategory()">üìÇ Pilih Kategori Ini</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>Channel yang Dipilih: <span id="selectedChannelCount">0</span> / <span id="totalChannelCount">0</span></h3>
                    <div id="playlistLoadingStatus" style="padding: 10px; background: #fff3cd; border-radius: 5px; margin-bottom: 10px; display: none;">
                        ‚è≥ Loading channels...
                    </div>
                    <div id="channelSelectionList" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                        <p style="text-align: center; color: #999;">Pilih user terlebih dahulu</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-primary" onclick="generatePlaylist()" id="generateBtn" disabled>
                        üì• Generate & Download Playlist
                    </button>
                    <button class="btn" onclick="saveAndCopyPlaylistURL()" id="copyUrlBtn" disabled>
                        üîó Save & Copy URL
                    </button>
                </div>
                
                <div id="playlistUrlBox" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">üîó Playlist URL</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="generatedPlaylistUrl" readonly style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white;">
                        <button class="btn btn-primary" onclick="copyToClipboard()">üìã Copy</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import M3U Tab -->
        <div id="import" class="tab-content">
            <h2>Import M3U Playlist</h2>
            <div style="max-width: 600px;">
                <div class="form-group">
                    <label>Nama Playlist</label>
                    <input type="text" id="playlistName" placeholder="Contoh: My IPTV">
                </div>
                <div class="form-group">
                    <label>M3U URL</label>
                    <input type="text" id="playlistUrl" placeholder="http://example.com/playlist.m3u">
                </div>
                <button class="btn btn-primary" onclick="importPlaylist()">Import Playlist</button>
                <div id="importStatus"></div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>üîë Ganti Password Admin</h3>
                <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" onsubmit="changePassword(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password Lama:</label>
                        <input type="password" id="adminOldPassword" required autocomplete="current-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Password Baru:</label>
                        <input type="password" id="adminNewPassword" required autocomplete="new-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <small style="color: #666; display: block; margin-top: 5px;">Minimal 6 karakter</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Konfirmasi Password Baru:</label>
                        <input type="password" id="adminConfirmPassword" required autocomplete="new-password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeChangePasswordModal()" class="btn" style="background: #666;">Batal</button>
                        <button type="submit" class="btn" style="background: #2196F3;">üíæ Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Load JavaScript Modules -->
    <script src="/app.js?v=1733267131"></script>
    <script src="/playlist.js?v=1733267131"></script>
    <script src="/channels.js?v=1733267131"></script>
    <script src="/bandwidth.js?v=1733267131"></script>
    <script src="/relay.js?v=1733267131"></script>
    <script src="/users.js?v=1733267131"></script>
    <script src="/generate-playlist.js?v=1733267131"></script>
    
    <script>
        // Get username to display
        async function loadUsername() {
            try {
                const response = await fetch('/api/auth/check');
                const result = await response.json();
                
                if (result.authenticated && result.username) {
                    const usernameEl = document.getElementById('adminUsername');
                    if (usernameEl) {
                        usernameEl.textContent = 'üë§ ' + result.username;
                    }
                }
            } catch (error) {
                console.error('Failed to load username:', error);
            }
        }
        
        // Logout function
        async function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    window.location.href = '/login.html';
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            }
        }
        
        // Load username on page load
        // Change Password Modal Functions
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('changePasswordForm').reset();
        }
        
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('changePasswordModal');
            if (event.target === modal) {
                closeChangePasswordModal();
            }
        }
        
        // Change Password Function
        async function changePassword(event) {
            event.preventDefault();
            
            // Get values from admin password modal (NOT user management form)
            const oldPassword = document.getElementById('adminOldPassword').value;
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            
            // Validate old password not empty
            if (!oldPassword || oldPassword.length === 0) {
                alert('‚ùå Password lama tidak boleh kosong!');
                return;
            }
            
            // Validate new password not empty
            if (!newPassword || newPassword.length === 0) {
                alert('‚ùå Password baru tidak boleh kosong!');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 6) {
                alert('‚ùå Password baru minimal 6 karakter! (Saat ini: ' + newPassword.length + ' karakter)');
                return;
            }
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                alert('‚ùå Password baru dan konfirmasi password tidak cocok!');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Password berhasil diubah!');
                    closeChangePasswordModal();
                    document.getElementById('changePasswordForm').reset();
                } else {
                    alert('‚ùå ' + (result.error || 'Gagal mengubah password. Periksa password lama Anda.'));
                }
            } catch (error) {
                console.error('Change password error:', error);
                alert('‚ùå Terjadi kesalahan saat mengubah password.');
            }
        }
    </script>
</body>
</html>
